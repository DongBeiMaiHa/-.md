## 一、微服务架构概述

	微服务架构是当前软件开发领城的技术热点。它在各种博客、社交媒体和会议演讲上的
	出镜率非常之高,相信大家也都听说过微服务这个名词。然而微服务似乎又是非常
	虚幻的一我们找不到微服务 的完整定义，以至于很多人认为是在炒作概念。
	那么什么是微服务呢?它解决了哪些问题?它又具有哪些特点?
	
	1.1 单体应用架构存在的问题
	一个归档包(例如war格式)包含所有功能的应用程序,通常称为单体应用。而架构单
	体应用的方法论，就是单体应用架构。
	
	就像之前的权限案例,商城项目等，这些应用尽管已经进行了模块化，但由于UI和若干业务模块最终都被打
	包在一个war包中.该war包包含了整个系统所有的业务功能，这样的应用系统称为单体应用。
	
	相信很多项目都是从单体应用开始的。单体应用比较容易部署、测试，在项目的初期，
	单体应用!可以很好地运行。然后，随着需求的不断增加，越来越多的人加人开发团队，
	代码库也在快速地膨胀。慢慢地，单体应用变得越来越臃肿，可维护性、灵活性逐渐降
	低，维护成本越来越高。下面列举了单体应用存在的一些问题。
	
	复杂性高 : 以一个百万行级别的单体应用为例，整个项目包含的模块非
	常多、模块的边界模糊、依赖关系不清晰、代码质量参羌不齐、混乱地堆砌在一起
	..整个项目非常复杂。每次修改代码都心惊胆战，其至添加一一个简单的功能，或
	者修改个Bug都会带来隐含的缺陷。
	
	技术债务 : 随着时间推移、需求变更和人员史迭，会逐渐形成应用程序的技术债务，
	并且越积越多。“不坏不修( Not brokcn, don't fix)”，这在软件开发中非常常见，在单
	体应用中这种思想更甚。已使用的系统设计或代码难以被修改，因为应用程序中的
	其他模块可能会以意料之外的方式使用它。

	部署频率低 : 随着代码的增多，构建和部署的时间也会增加。而在单体应用中，每
	次功能的变更或缺陷的修复都会导致需要重新部界整个应用。全量部署的方式耗时
	长、影响范围大、风险高，这使得单体应用项日上线部署的频率较低。而部署频率
	低义宁致两次发布之间会有大量的功能变更和缺陷修复，出错桃概率比较高。
	
	可靠性差 : 某个应用Bug，例如死循坏、OOM等，可能会导致幣个应用的崩溃。
	
	扩展能力受限 : 单体应用只能作为一个整体进行扩展，无法根据业务模块的需要进
	行伸缩。例如，应用中有的模块是计算密集型的，它需要强劲的CPU;有的模块则
	是IO密集型的，需要更大的内存。由于这些模块部署在- -起，不得不在硬件的选择
	上做出妥协。
	
	阻碍技术创新 : 单体应用往往使用统一的技 术平台或方案解决所有的问题，团队中
	的每个成员都必须使用相同的开发语言和框架，要想引入新框架或新技术平台会非
	常困难。例如，一个使用Struts2构建的、有100万行代码的单体应用，如果想要换
	用SpringMVC，毫无疑问切换的成本是非常高的。
	综上，随着业务需求的发展，功能的不断增加，单体架构很难满足互联网时代业务快速
	变化的需要。那么，如何解决单体应用架构存在的问题呢?
	
	1.2 如何解决单体应用架构存在的问题
	综上所述，单体应用架构存在很多的问题。有没有-种架构模式可以有助于解决这些问
	题呢?
	微服务就是这样的一种架构模式。下面将着重介绍什么是微服务，以及使用微服务架构
	有哪些优点与挑战。
	1.3 什么是微服务
	就目前来看，微服务本身并没有一个严格的定义,每个人对微服务的理解都不同。Martin
	Fowler在他的博客中是这样描述微服务的。
	In short, the microservice architectural style is an approach to developing a single
	application as a suite of small services, each running in its own process and commu-
	nicating with lightweight mechanisms, often an HTTP resource API. These services
	are built around business capabilities and independently deployable by fully auto-
	mated deployment machinery. There is a bare minimum of centralized management
	of these services, which may be written in different programming languages and use
	different data storage technologies.
	用中文表述就是,微服务架构风格是一种将- -个单一应用程序开发为一-组小型服务的方 
	法，每个服务运行在自己的进程中，服务间通信采用轻量级通信机制(通常用HTTP资
	源API)。这些服务围绕业务能力构建并且可通过全自动部署机制独立部署。这些服务共
	用一个最小型的集中式的管理，服务可用不同的语言开发,使用不同的数据存储技术。

	服务间通信(分布式开发或微服务开发不同模块(项目)直接的沟通方式(调用方式))
	具体的实现 : RMI、MINA、ESB、Burlap、Hessian、SOAP、EJB和JMS等

	基本原理 
	要实现网络机器间的通讯，首先得来看看计算机系统网络通信的基本原理，在底层层面去看，网络通信需要做的就是将流从一台计算机传输到另外一台计算机，基于 传输协议和网络IO来实现，其中传输协议比较出名的有http、tcp、udp等等，http、tcp、udp都是在基于Socket概念上为某类应用场 景而扩展出的传输协议，网络IO，主要有bio、nio、aio三种方式，所有的分布式应用通讯都基于这个原理而实现，只是为了应用的易用性，各种语言通 常都会提供一些更为贴近应用易用的应用层协议。
	
	从中可以看到，微服务架构应具备以下特性;
	1. 每个微服务可独立运行在自己的进程里。
	2. 一系列独立运行的微服务共同构建起整个系统。
	3. 每个服务为独立的业务开发，一个微服务只关注某个特定的功能，例如订单管理、用户管理等。
	4. 微服务之间通过一些经量的通信机制进行通信，例如通过RESTful API进行调用。
	5. 可以使用不同的语言与数据存储技术。
	6. 全自动的部署机制。
	还以商城系统为例，使用微服务来架构该应用，将整个应用分解为多个微服务，各个微服务独立运行在自己的进程中，并分别有自己的
	数据库，微服务之间使用REST或者其他协议通信。
	Martin Fowler 
	《微服务》博客原义: http://www.martinfowler. com/articles/microservices.htmil,
				 译义: http://blog. cuicc com/ biog/2015/07/22/microservices/.
	1.4微服务架钩的优点与挑战
	相对单体应用架构来说，微服务架构有着显著的优点。但足，微服务并非是完美的，使
	用微服务也为我们的工作带来了一定的挑战。先来分析--下使用微服务有哪些优点。
	
	1.4.1微服务架构的优点
	微服务架构有如下优点。
	 1. 易于开发和维护 : 一个微服务只会关注一一个特定的业务功能，所以它业务清晰、代码量较少。开发和维护单个微服务相对简单。而整个应用是由若干个微服务构建而成的，所以整个应用也会被维持在一一个可控状态。
	 2. 单个微服务启动较快:单个微服务代码量较少，所以启动会比较快。
	 3. 局部修改容易部署:单体应用只要有修改，就得重新部署整个应用，微服务解决了这样的问题。一般来说，对某个微服务进行修改，只需要重新部署这个服务即可。
	 4. 技术栈不受限:在微服务架构中，可以结合项目业务及团队的特点，合理地选择技术栈。例如某些服务可使用关系型数据库MySQL;某些微服务有图形计算的需求，可以使用Neo4;甚至可根据需要,部分微服务使用Java开发,部分微服务使用Node.js开发。
	 5. 按需伸缩:可根据需求，实现细粒度的扩展。例如，系统中的某个微服务遇到了瓶颈，可以结合这个微服务的业务特点，增加内存、升级CPU或者是增加节点。
	
	综上所述，单体应用架构的缺点，恰恰是微服务的优点，而这些优点使得微服务看起来
	简直非常完美。然而完美的东西并不存在，就像银弹不存在一样。下面来讨论使用微服
	务会带来哪些挑战。
	
	1.4.2微服务架构面临的挑战
	微服务虽然有很多吸引人的地方，但它并不是免费的午餐，使用它是有代价的。本节将
	讨论使用微服务架构面临的挑战。
	1. 运维要求较高 : 更多的服务意味着更多的运维投入。在单体架构中，只需要保证一个应用的正常运行。而在微服务中，需要保证几十甚至几百个服务的正常运行与协作，这给运维带来了很大的挑战。
	2. 分布式固有的复杂性 : 使用微服务构建的是分布式系统。对于一个分布式系统，系统容错、网络延迟、分布式事务等都会带来巨大的挑战。
	3. 接口调整成本高 : 微服务之间通过接口进行通信。如果修改某一个微服务的API,可能所有使用了该接口的微服务都需要做调整。
	4. 重复劳动 : 很多服务可能都会使用到相同的功能，而这个功能并没有达到分解为一个微服务的程度，这个时候，可能各个服务都会开发这一功能，从而导致代码重复。
	
	尽管可以使用共享库来解决这个问题(例如可以将这个功能封装成公共组件，需要该功能的微服务引用该组件)，但共享库在多语言环境下就不一定行得通了。

	1.5	微服务设计原则
	和数据库设计中的N范式--样，微服务也有一定的设计原则，这些原则指导我们更加
	合理地架构微服务。
	1. 单一职责原则
	单一职责原则指的是-一个单元 (类、方法或者服务等)只应关注整个系统功能中单
	独、有界限的一-部分。单一职责原则可以帮助我们更优雅地开发、更敏捷地交付。
	单- -职责原则是SOLID原则之一。有兴趣的读者可前往https://en. wikipedia.org/wiki/
	SOLID_ (object- oriented_ design) 进行扩展阅读。
	2. 服务自治原则
	服务自治是指每个微服务应具备独立的业务能力、依赖与运行环境。在微服务架构
	中，服务是独立的业务单元，应该与其他服务高度解耦。每个微服务从开发、测试、
	构建、部署，都应当可以独立运行，而不应该依赖其他的服务。
	3. 轻量级通信机制
	微服务之间应该通过轻量级的通信机制进行交互。笔者认为，轻量级的通信机制应
	具备两点:首先是它的体量较轻;其次是它应该是跨语言、跨平台的。例如我们所
	熟悉的REST协议，就是- - 个典型的“轻量级通信机制”;而例如Java 的RMI则协议
	就不大符合轻量级通信机制的要求，因为它绑定了Java 语言。
	微服务架构中，常用的协议有REST、AMQP、STOMP、MQTT等。
	4. 微服务粒度
	微服务的粒度是难点，也常常是争论的焦点。应当使用合理的粒度划分微服务，而
	不是一味地把服务做小。代码量的多少不能作为微服务划分的依据，因为不同的微
	服务本身的业务复杂性不同，代码量也不同。
	在微服务的设计阶段,就应确定其边界。微服务之间应相对独立并保持松耦合。笔者
	认为,领域驱动设计( Domain Driven Design,简称DDD )中的‘界限上下文( Bounded
	Context)”可作为划分微服务边界、确定微服务粒度的重要依据。限于篇幅，DDD
	的内容无法展开讲解，对DDD感兴趣的读者朋友们可阅读《Domain Driven Design
	Quickly》快速入门，也可阅读DDD开山鼻祖Eric Evans的《领域驱动设计:软件核
	心复杂性应对之道》深人理解。同时，在划分微服务的过程中，还应综合考量团队
	的现状。康威定律( Conway's Law)相信大家已经很熟悉了，笔者不再赘述。
	微服务架构的演进是一-个循序渐进的过程。在演进过程中，常常会根据业务的变化，对
	微服务进行重构，甚至是重新划分，从而让架构更加合理。最终，当微服务的开发、部
	署、测试以及运维的效率很高，并且成本很低时，一个好的微服务架构就形成了。
	目
	《Domain Driven Design Quickly》 
	阅读地址: https://www. infoq.com/minibooks/ domain- driven- design-quickly/o《Domain Driven Design Quickly》 
	中文版《领域驱动设计精简版》: http://www.infoq.com/cn/minibooks/domain- driven- design- quickly- new。
	1.6如何实现微服务架构
	至此，不仅知道了微服务架构的定义及其优缺点，还总结了- -些指导性的原则，为合理
	架构微服务提供了理论支持。
	下面来探讨一下，如何实现微服务架构。
	1.6.1技术选型
	相对单体应用的交付,微服务应用的交付要复杂很多，不仅需要开发框架的支持，还需
	要一些自动化的部署工具，以及IaaS、PaaS 或CaaS的支持。
	下面从开发和运行平台两个维度考虑挑选技术选型。
	
	开发框架的选择
	可使用Spring Cloud作为微服务开发框架。
	首先，Spring Cloud具备开箱即用的生产特性，可大大提升开发效率;再者，Spring 
	Cloud的文档丰富、社区活跃，遇到问题比较容易获得支持，更为可贵的是，Spring .
	Cloud为微服务架构提供了完整的解决方案。
	当然，也可使用其他的开发框架或者解决方案来实现微服务,例如Dubbo、Dropwiz-
	ard、Armada 等。
	
	运行平台
	微服务并不绑定运行平台，将微服务部署在PC Server,或者阿里云、AWS等云计
	算平台都是可以的。出于轻量、灵活、应用支撑等方面的考虑.


## 二、	微服务开发框架---Spring Cloud

	2.1 Spring Cloud简介
	尽管Spring Cloud带有“Cloud” 的字样，但它并不是云计算解决方案，而是在Spring Boot基础上构建的，用于快速构建分布式系统的通用模式的工具集。

	使用Spring Cloud开发的应用程序非常适合在Docker或者PaaS ( 例如Cloud Foundry )
	上部署，所以又叫作云原生应用( Cloud Native Application )。 云原生( Cloud Native )可
	简单理解为面向云环境的软件架构。说到云原生，就不得不提一下《十二要素应用宣言( 12-factor Apps )》
	,这是云原生架构的方法论与最佳实践。有兴趣的查询百度了解下。
	
	2.2 Spring Cloud特点
	Spring Cloud有以下特点:
	 1. 约定优于配置。
	 2. 适用于各种环境。开发、部署在PC Server 或各种云环境(例如阿里云、AWS等)均可。
	 3. 隐藏了组件的复杂性，并提供声明式、无xml的配置方式。
	 4. 开箱即用，快速启动。
	 5. 轻量级的组件。Spring Cloud整合的组件大多比较轻量。例如Eureka、Zuul, 等等，都是各自领域轻量级的实现。
	 6. 组件丰富，功能齐全。Spring Cloud为微服务架构提供了非常完整的支持。例如，配置管理、服务发现、断路器、微服务网关等。
	 7. 选型中立、丰富。例如，Spring Cloud支持使用Eureka、Zookeeper 或Consul实现服务发现。
	 8. 灵活。SpringCloud的组成部分是解耦的，开发人员可按需灵活挑选技术选型。
	2.3 Spring Cloud版本
		大多数Spring项目都是以“主版本号.次版本号.增量版本号.里程碑版本号”的形式命
		名版本号的，例如Spring Framework稳定版本4.3.5.RELEASE、里程碑版本5.0.0.M4 等。
		其中，主版本号表示项目的重大重构;次版本号表示新特性的添加和变化;增量版本号
		一般表示Bug修复;里程碑版本号表示某版本号的里程碑。
		然而，Spring Cloud并未使用这种方式管理版本。下面来详细探讨一下 Spring Cloud的
		版本。
	2.3.1版本简介
		先看一下Spring Cloud的版本.
		Edgware SR4
		Dalston SR4
		Camden SR7
		Spring Cloud是以英文单词SRX (X为数字)的形式命名版本号的。那么英文单词和SR分别表示什么呢?
		Spring Cloud是-一个综合项目， 它包含很多的子项目。由于子项目也维护着自己的版本
		号，Spring Cloud采用了这种版本命名方式，从而避免与子项目的版本混淆。其中，英
		文单词叫作“ release train”，Angel 、Brixton 、Camden等都是伦敦地铁站的名称，它们
		按照字母顺序发行，可将其理解为主版本的演进。SR表示“Service Release”, 一般表示
		Bug修复;在SR版本发布之前，会先发布一个Release版本，例如Camden RELEASE。

		Spring Cloud并没有熟悉的数字版本号，而是对应一个开发代号。

		Cloud代号	Boot版本(train)	Boot版本(tested)	lifecycle
		Angle		1.2.x	incompatible with 1.3	EOL in July 2017
		Brixton		1.3.x	1.4.x					2017-07卒
		Camden		1.4.x	1.5.x	-
		Dalston		1.5.x	not expected 2.x	-
		Edgware		1.5.x	not expected 2.x	-
		Finchley	2.x	not expected 1.5.x	-

		版本解释 : https://www.cnblogs.com/xingzc/p/9414208.html,可以百度查询


## 3. Spring Cloud 实战

	Spring Cloud不一定适合所有人。先来探讨一下，玩转Spring Cloud需要具备什么样的
	技术能力，以及在实战中会使用到哪些工具。
	3.1.1技术储备
	Spring Cloud并不是面向零基础开发人员的，它有一定的学习曲线。
	语言基础: Spring Cloud是一一个基于Java语言的工具套件，所以学习它需要一定的
	Java基础。当然，Spring Cloud同样也支持使用Scala、Groovy等语言进行开发。

	Spring Boot: Spring Cloud是基于Spring Boot构建的，因此它延续了Spring Boot的契
	约模式以及开发方式。如果大家对Spring Boot不熟悉，建议花一点时间人门。
	
	项目管理与构建工具:目前业界比较主流的项目管理与构建工具有Maven和Gradle
	等,我采用的是目前相对主流的Maven。大家也可使用Gradle管理与构建项目。并
	且，Maven与Gradle项目可以互相转换，例如，使用以下命令即可将Maven项目转
	换为Gradle项目。
	gradle init --type pom

	3.1.2 工具及软件版本
	目前SpringCloud正在飞速地发展，是业界有名的“版本帝”。2015年7月,SpringCloud才
	刚刚发布Angel RELEASE;而2016年5月，Spring Cloud就已经发布到Brixton RELEASE;
	到2016年9月，Spring Cloud又发布了新一代产品Camden RELEASE。随着版本的演进,
	SpringCloud带来了更丰富的组件、更强大的功能，并解决了很多遗留的Bug
	新版本未必代表着完美，但老版本往往意味着过时或即将过时。基于这个原则,使
	用目前最新的Release版本进行讲解。涉及到的新特性，会尽量标记并做出讲解。
	下面列出了所使用的各个软件及其版本。
	JDK: Spring Cloud官方建议使用JDK 1.8。 当然，Spring Cloud也支持通过一 -定的配
	置，使用JDK1.7进行开发。
	Spring Boot: 本书使用Spring Boot 2.1.9.RELEASE。
	Spring Cloud: 使用Spring Cloud Greenwich.RELEASE
	IDE的选择:选择一款强大的 IDE往往能够事半功倍。使用的IDE是Spring官方
	提供的Spring Tool Suite 3.8.3,这是一个基于Eclipse 的IDE。当然，使用IntelliJ IDEA
	等IDE进行开发也是可以的。
	Maven: 使用Maven 3.3.9构建项目。和Spring Boot、 Spring Cloud - 一样，Maven	3.3.x默认也是运行在JDK18之上的。如果想使用1.8以下版本的JDK,需要做-一些额外的配置。

	3.2 服务提供者与服务消费者

	使用微服务构建的是分布式系统，微服务之间通过网络进行通信。我们使用服务提供者
	与服务消费者来描述微服务之间的调用关系。
	下面解释了服务提供者与服务消费者。

	名词			定义
	服务提供者	服务的被调用方(即:为其他服务提供服务的服务)
	服务消费者	服务的调用方(即:依赖其他服务的服务)

	我们继续以售票系统为例。用户向电影微服务发起了一一个购票的请求。在
	进行购票的业务操作前，电影微服务需要调用用户微服务的接口，查询当前用户的余额
	是多少，是不是符合购票标准等。在这种场景下，用户微服务就是一个服务 提供者，电
	影微服务则是一个服务消费者。
	购票	~查询用户信急

	围绕该场景，先来编写-一个用户微服务，然后编写一个电影微服务。